!function(a,b){if("function"==typeof define&&define.amd)define(["underscore","backbone","exports"],function(c,d,e){a.Backbone=b(a,e,c,d)});else if("undefined"!=typeof exports){var c=require("underscore"),d=require("backbone");b(a,exports,c,d)}else a.Backbone=a._.extend(a.Backbone,b(a,{},a._,a.Backbone))}(this,function(a,b,c,d){"use strict";var e={};return e.WreqrChannel=function(a,b,c,e){if(a){var f=!1,g=d.Wreqr;b&&c&&e?b instanceof g.EventAggregator?c instanceof g.Commands?e instanceof g.RequestResponse||(f=!0):f=!0:f=!0:f=!0,f&&(b=new g.EventAggregator,e=new g.RequestResponse,c=new g.Commands),this.vent=b,this.reqres=e,this.commands=c,this.channelName=a}},c.extend(e.WreqrChannel.prototype,{reset:function(){return this.vent.off(),this.vent.stopListening(),this.reqres.removeAllHandlers(),this.commands.removeAllHandlers(),this},connectEvents:function(a){return this._connect("vent",a),this},connectCommands:function(a){return this._connect("commands",a),this},connectRequests:function(a){return this._connect("reqres",a),this},_connect:function(a,b){if(b){b=this._methodsFromHash(b);var d="vent"===a?"on":"setHandler";c.each(b,function(b,e){this[a][d](e,c.bind(b,this))},this)}},_methodsFromHash:function(a){var b,d={};return c.each(a,function(a,e){b=a,c.isFunction(b)||(b=this[b]),b&&(d[e]=b)},this),d}}),e.WreqrStation={attachChannel:function(a){return a&&a instanceof d.WreqrChannel?(this._channels=this._channels||[],c.contains(this._channels,a)||this._channels.push(a),a):void 0},detachChannel:function(a,b){if(this._channels&&a){var d=this.channel(a);if(d)return b===!0&&d.reset(),this._channels=c.without(this._channels,d),d}},detachAllChannels:function(a){if(this._channels){var b;c.each(this._channels,function(c){b=c.channelName,this.detachChannel(b,a)},this)}},channel:function(a){return this._channels?c.findWhere(this._channels,{channelName:a}):void 0},hasChannel:function(a){if(this._channels){var b=c.findWhere(this._channels,{channelName:a});return b?!0:!1}}},e}),function(){var a=machina.Fsm.extend({initialize:function(){console.log("Init")},initialState:"stopped",states:{stopped:{_onEnter:function(){console.log("Stopped")},pasta:function(){console.log("Stopped is handling this pasta")}},started:{_onEnter:function(){console.log("Started")},truck:function(){console.log("Started is handling this truck")}}}});window.Puppets=window.Puppets||{},window.Puppets.Fsm=a}(),function(){var a=Marionette.Region.extend({_defaultDuration:500,_defaultTransition:"pop",constructor:function(){Marionette.Region.prototype.constructor.apply(this,Array.prototype.slice(arguments))},_trigger:function(a){this.vent.trigger("region:"+a)},open:function(a){a.delegateEvents(),"fade"===this.transition?this.slide(this.$el,"in",a):"slide"===this.transition?this.fade(this.$el,"in",a):this.pop(this.$el,"in",a)},closeView:function(a){a.close?a.close():a.remove&&a.remove(),this._trigger("close"),Marionette.triggerMethod.call(this,"close"),delete this.currentView},slide:function(a,b,c){var d=this;"in"===b?(d._trigger("open"),a.hide(),a.html(c.el),a.slideDown(d.duration,function(){d._trigger("ready")})):(d._trigger("closing"),a.slideUp(d.duration,function(){_.bind(d.closeView,d,c)()}))},fade:function(a,b,c){var d=this;if("in"===b){a.hide(),a.html(c.el);var d=this;d._trigger("open"),a.fadeIn(d.duration,function(){d._trigger("ready")})}else d._trigger("closing"),a.fadeOut(d.duration,function(){_.bind(d.closeView,d,c)()})},pop:function(a,b,c){"in"===b?(this._trigger("open"),a.empty().append(c.el),this._trigger("ready")):(this._trigger("closing"),a.empty(),_.bind(this.closeView,this,c)())},close:function(){var a=this.currentView;a&&!a.isClosed&&("fade"===this.transition?this.slide(this.$el,"out",a):"slide"===this.transition?this.fade(this.$el,"out",a):this.pop(this.$el,"out",a))}});window.Puppets=window.Puppets||{},window.Puppets.Region=a}(),function(){var a=Marionette.ItemView.extend({modelEvents:{change:"update"},constructor:function(){this._rendered=!1,Marionette.View.prototype.constructor.apply(this,Array.prototype.slice.apply(arguments))},render:function(){this.isClosed=!1,this.triggerMethod("before:render",this),this.triggerMethod("item:before:render",this);var a=this.serializeData();a=this.mixinTemplateHelpers(a);var b=this.getTemplate(),c=Marionette.Renderer.render(b,a);return this.$el.html(c),this.bindUIElements(),this.triggerMethod("render",this),this.triggerMethod("item:rendered",this),this},updateDOM:function(){var a=$.Deferred();this.updatePromises.push(a),a.resolve()},update:function(){this._isRendered&&(this._shareUpdating(),this.updatePromises=[],this.updateDOM.apply(this,Array.prototype.slice.apply(arguments)),$.when.apply($,this.updatePromises).then(_.bind(this._shareUpdate,this)))},_shareUpdating:function(){this.vent.trigger("view:updating")},_shareUpdate:function(){this.vent.trigger("view:update")}});window.Puppets=window.Puppets||{},window.Puppets.ItemView=a}(),window.Puppets.Puppet=Marionette.Module.extend({constructor:function(a,b,c){this.puppetName=a,this.app=b,c=c||{},this.configureLocalChannel(),this.configureGlobalChannel();var d=new Backbone.WreqrChannel("local"),e=new Backbone.WreqrChannel("global",this.app.vent,this.app.commands,this.app.reqres),d=this.attachChannel(d),e=this.attachChannel(e);this.fsm=new Puppets.Fsm,this._configRegion(c),Marionette.Controller.prototype.constructor.apply(this,Array.prototype.slice(arguments)),this._components={},this._linkComponents(),this.configureComponents(c)},configureLocalChannel:function(){var a=new Backbone.WreqrChannel(name);this.attachChannel(a)},configureGlobalChannel:function(){this.attachChannel("global",this.app.vent,this.app.commands,this.app.reqres)},configureComponents:function(){},_configRegion:function(a){if(a.region){this.component("region",a.region);var b=this.component("region");b.duration=a.duration||Puppets.Region._defaultDuration,b.transition=a.transition||Puppets.Region._defaultTransition}},component:function(a,b){return b?_.has(this._components,a)?!1:(this._components[a]=b,void 0):this._components[a]},_linkComponents:function(){var a=this.channel("local");this.components&&_.each(this.components,function(b,c){b.componentName=c,b.puppetName=this.puppetName,_.extend(b,Backbone.WreqrChannel),b.attachChannel("local",a.vent,a.commands,a.reqres),this.component(c,b)},this)},_startedPuppet:function(){this._changeState("started"),this.emitGlobalEvent("start")},_readyPuppet:function(){this._changeState("ready"),this.emitGlobalEvent("ready")},_stoppingPuppet:function(){this._changeState("stopping"),this.emitGlobalEvent("closing")},_stoppedPuppet:function(){this._changeState("stopped"),this.emitGlobalEvent("close")},_shareViewUpdating:function(){this.emitGlobalEvent("updating")},_shareViewUpdate:function(){this.emitGlobalEvent("update")},start:function(){this.region&&this.itemView&&this.region.show(this.itemView)},stop:function(){this.region&&this.region.close()},_defaultEvents:{local:{vent:{"open:region":"_startedPuppet","ready:region":"_readyPuppet","closing:region":"_stoppingPuppet","close:region":"_stoppedPuppet"}},global:{commands:{start:"start",stop:"stop"},requests:{isStarted:"_isStarted",isReady:"_isReady",isStopping:"_isStopping",isStopped:"_isStopped"}}},_suffixEventName:function(a){return a+":puppets."+this.puppetName},emit:function(a){arguments[0]=this._suffixEventName(a),this.app.vent.trigger.apply(this.app.vent,Array.prototype.slice.apply(arguments))}}),_.extend(window.Puppets.Puppet.prototype,Backbone.WreqrStation);