!function(a,b){if("function"==typeof define&&define.amd)define(["underscore","backbone","exports"],function(c,d,e){a.Backbone=b(a,e,c,d)});else if("undefined"!=typeof exports){var c=require("underscore"),d=require("backbone");b(a,exports,c,d)}else a.Backbone.Wreqr=a._.extend(a.Backbone.Wreqr,b(a,{},a._,a.Backbone)),a.Backbone.radio=a.Backbone.Wreqr.radio}(this,function(a,b,c,d){"use strict";var e={_channels:{},vent:{},commands:{},reqres:{},channel:function(a){return a=a||"/",this._getChannel(a)},_getChannel:function(a){var b;return c.has(this._channels,a)?b=this._channels[a]:(b=new j(a),this._channels[a]=b),b},_forwardFn:function(a,b,c){b=this._getChannel(a)[b];var d=Array.prototype.slice.call(arguments,3);b[c].apply(b,d)}},f={vent:["on","off","trigger","once","stopListening","listenTo","listenToOnce"],handler:["setHandler","setHandlers","removeHandler","removeAllHandlers"],commands:["execute"],reqres:["request"]},g=f.vent,h=c.union(f.commands,f.handler),i=c.union(f.reqres,f.handler);c.each(g,function(a){e.vent[a]=function(b){var c=Array.prototype.slice.call(arguments,1);c.unshift(b,"vent",a),e._forwardFn.apply(e,c)}}),c.each(h,function(a){e.commands[a]=function(b){var c=Array.prototype.slice.call(arguments,1);c.unshift(b,"commands",a),e._forwardFn.apply(e,c)}}),c.each(i,function(a){e.reqres[a]=function(b){var c=Array.prototype.slice.call(arguments,1);c.unshift(b,"reqres",a),e._forwardFn.apply(e,c)}});var j=function(a){this.vent=new d.Wreqr.EventAggregator,this.reqres=new d.Wreqr.RequestResponse,this.commands=new d.Wreqr.Commands,this.channelName=a};c.extend(j.prototype,{reset:function(){return this.vent.off(),this.vent.stopListening(),this.reqres.removeAllHandlers(),this.commands.removeAllHandlers(),this},connectEvents:function(a){return this._connect("vent",a),this},connectCommands:function(a){return this._connect("commands",a),this},connectRequests:function(a){return this._connect("reqres",a),this},_connect:function(a,b){if(b){b=this._normalizeMethods(b);var d="vent"===a?"on":"setHandler";c.each(b,function(b,e){this[a][d](e,c.bind(b,this))},this)}},_attach:function(a,b,d,e){this[a][b](d,c.bind(e,this))},_normalizeMethods:function(a){var b,d={};return c.each(a,function(a,e){b=a,c.isFunction(b)||(b=this[b]),b&&(d[e]=b)},this),d}});var k={};return k.radio=e,k.Channel=j,k}),function(){var a=machina.Fsm.extend({initialize:function(){console.log("Init")},initialState:"stopped",states:{stopped:{_onEnter:function(){console.log("Stopped")},"some:event":"started",lala:function(){console.log("RECEIVED")}},started:{_onEnter:function(){console.log("Started")}}}});window.Puppets=window.Puppets||{},window.Puppets.Fsm=a}(),window.Puppets=window.Puppets||{},window.Puppets.Puppet=Marionette.Module.extend({constructor:function(a,b,c){this.app=b,this.puppetName=a,this.statesConfig={},c=c||{},this.channels={global:Backbone.radio.channel("global"),local:Backbone.radio.channel("puppets."+a),"fsm.events":Backbone.radio.channel("puppets."+a+".events")},this.vent=this.channels.local.vent,this.commands=this.channels.local.commands,this.reqres=this.channels.local.reqres,Marionette.Module.prototype.constructor.apply(this,Array.prototype.slice.call(arguments,0)),this._afterInit(c)},_attachValue:function(a){console.log("lala",a)},_generateEventsMap:function(a){var b={};return _.each(a,function(a,c){_.isArray(a)?_.each(a,function(a){b[a]=b[a]||[],b[a].push(c)},this):_.isString(a)&&(b[a]=b[a]||[],b[a].push(c))},this),b},_setFsmStates:function(a){var b=a&&a.actions,c=this.statesMap,d=_.keys(c),e=this.component("controller"),f=this._generateEventsMap(c);b&&c&&e&&(console.log(d),_.each(b,function(a,b){if(_.has(f,b)){var c=f[b];_.each(c,function(a){console.log("~~~",b,a),_.contains(d,b)?(console.log("TRANSITION",b),this.statesConfig[a]=this.statesConfig[a]||{},this.statesConfig[a][b]=a):_.isFunction(e[b])?(console.log("ATTACHED",b),this.statesConfig[a]=this.statesConfig[a]||{},this.statesConfig[a][b]=e[b]):console.log("NOT ATTACHED",b)},this)}else _.isFunction(e[b])?this.vent.on(a,b):console.log("Neither",b)},this))},_attachMethodsToStates:function(a,b,c){this.component("controller");return _.isString(c)?a?void 0:(this._throw('The state "'+a+'" has no associated methods on Puppet.'+this.puppetName),void 0):(this._throw('States must be a string. "'+c+'" is not a string on Puppet.'+this.puppetName),void 0)},_attachTransitionsToStates:function(a,b,c){return _.isString(c)?a?(_.contains(this.states,c)||this._throw('"'+c+'" is not a valid state for Puppet.'+this.puppetName),"*"===a&&console.log(c+" is transitioned to from all states"),_.isString(a)?this._attachTransitionToState(a,c,b):_.isArray(a)&&_.each(a,function(a){this._attachTransitionToState(a,c,b)},this),void 0):(this._throw('The state "'+a+'" can not be transitioned to in Puppet.'+this.puppetName),void 0):(this._throw('States must be a string. "'+c+'" is not a string in Puppet.'+this.puppetName),void 0)},_attachTransitionToState:function(a,b,c){this.statesConfig[a]=this.states[a]||{},this.statesConfig[a][c]=b},_attachMethodToState:function(a,b,c){var d=this.component("controller"),e=d[c];return _.isFunction(e)?void 0:(this._throw(c+" not found on the controller of Puppet."+this.puppetName),void 0)},_afterInit:function(a){this._configureComponents(),this._setFsmStates(a),this.fsm=new Puppets.Fsm({namespace:"puppets."+this.puppetName})},_configureComponents:function(){var a;this._components={},_.each(this.components,function(b,c){a=this._components[c]=new b(this.options),a.channels=this.channels,a.componentName=c,a.puppetName=this.puppetName},this)},component:function(a,b){return b?_.has(this._components,a)?!1:(this._components[a]=b,b):this._components[a]},_defaultRequests:function(){return{}},_suffixEventName:function(a){return a+":puppets."+this.puppetName},_throw:function(a,b){b=b||"warn",console&&console[b]&&console[b]("Warning:",a)},emit:function(a){arguments[0]=this._suffixEventName(a),this.channels.global.vent.trigger.apply(this.app.vent,Array.prototype.slice.apply(arguments))}});