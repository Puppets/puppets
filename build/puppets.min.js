!function(a,b){if("function"==typeof define&&define.amd)define(["underscore","backbone"],function(c,d){return a.WreqrRadio=b(c,d)});else if("object"==typeof exports){var c=require("underscore"),d=require("backbone");module.exports=b(c,d)}else a.Backbone.Wreqr=a._.extend(a.Backbone.Wreqr,b(a._,a.Backbone)),a.Backbone.radio=a.Backbone.Wreqr.radio}(this,function(a,b){var c=function(a,b){"use strict";var c={_channels:{},vent:{},commands:{},reqres:{},channel:function(a){return a=a||"/",this._getChannel(a)},_getChannel:function(b){var c;return a.has(this._channels,b)?c=this._channels[b]:(c=new h(b),this._channels[b]=c),c},_forwardFn:function(a,b,c){b=this._getChannel(a)[b];var d=Array.prototype.slice.call(arguments,3);b[c].apply(b,d)}},d={vent:["on","off","trigger","once","stopListening","listenTo","listenToOnce"],handler:["setHandler","setHandlers","removeHandler","removeAllHandlers"],commands:["execute"],reqres:["request"]},e=d.vent,f=a.union(d.commands,d.handler),g=a.union(d.reqres,d.handler);a.each(e,function(a){c.vent[a]=function(b){var d=Array.prototype.slice.call(arguments,1);d.unshift(b,"vent",a),c._forwardFn.apply(c,d)}}),a.each(f,function(a){c.commands[a]=function(b){var d=Array.prototype.slice.call(arguments,1);d.unshift(b,"commands",a),c._forwardFn.apply(c,d)}}),a.each(g,function(a){c.reqres[a]=function(b){var d=Array.prototype.slice.call(arguments,1);d.unshift(b,"reqres",a),c._forwardFn.apply(c,d)}});var h=function(a){this.vent=new b.Wreqr.EventAggregator,this.reqres=new b.Wreqr.RequestResponse,this.commands=new b.Wreqr.Commands,this.channelName=a};a.extend(h.prototype,{reset:function(){return this.vent.off(),this.vent.stopListening(),this.reqres.removeAllHandlers(),this.commands.removeAllHandlers(),this},connectEvents:function(a,b){return this._connect("vent",a,b),this},connectCommands:function(a,b){return this._connect("commands",a,b),this},connectRequests:function(a,b){return this._connect("reqres",a,b),this},_connect:function(b,c,d){if(c){d=d||this;var e="vent"===b?"on":"setHandler";a.each(c,function(c,f){this[b][e](f,a.bind(c,d))},this)}}});var i={radio:c,Channel:h,VERSION:"1.2.0"};return i}(a,b);return c}),function(){"use strict";window.Puppets=window.Puppets||{},window.Puppets.Puppet=Marionette.Module.extend({constructor:function(a,b,c){this.app=b,this.puppetName=a,this.channelName=this._channelName(),this._options=c||{},this.channels={global:Backbone.radio.channel("global"),local:Backbone.radio.channel(this.channelName)},this._attachMessagingProtocols(this,this.channels.local),this._configurePieces(),this._initDefaultListeners(),Marionette.Module.prototype.constructor.apply(this,Array.prototype.slice.call(arguments,0)),this._addFinalizers()},_addFinalizers:function(){this.addFinalizer(function(){this.channels.local.reset()}),this.addFinalizer(function(){_.each(this._pieces,function(a){a.off&&a.off(),a.close?a.close():a.remove&&a.remove()},this)})},resetChannel:function(){this.channels.local.reset()},_configurePieces:function(){this._pieces={},_.each(this.pieces,function(a,b){this._createNewPiece(a,b)},this)},_createNewPiece:function(a,b){var c;c=this._pieces[b]=a.prototype instanceof Backbone.Model||a.prototype instanceof Backbone.Collection?new a(void 0,this._options):new a(this._options),this._setUpNewPiece(c,b)},_setUpNewPiece:function(a,b){a.pieceName=b,a.channelName=this.channelName,a.puppetName=this.puppetName,a.channels=this.channels,a.normalizeMethods=a.normalizeMethods||this.normalizeMethods,a.localEvents=a.normalizeMethods(a.localEvents),this._attachEvents(this.channelName,a.localEvents),this._attachMessagingProtocols(a,this.channels.local),this._listenToPieceEvents(a)},piece:function(a,b){return b?_.has(this._pieces,a)?!1:(this._pieces[a]=b,this._setUpNewPiece(b),b):this._pieces[a]},_listenToPieceEvents:function(a){_.matches(a,Backbone.Events)&&this.listenTo(a,"all",_.bind(this._forwardPieceEvent,this,a.pieceName))},_forwardPieceEvent:function(){var a=Array.prototype.slice.call(arguments,0);a[1]=a[1]+":"+a[0],a.shift(),this.vent.trigger.apply(this.vent,a)},_attachMessagingProtocols:function(a,b){a.commands=b.commands,a.reqres=b.reqres,a.vent=b.vent},_channelName:function(){return"puppet."+this.puppetName},_initDefaultListeners:function(){this._normalizeEventsGroup(this.localEvents),this._normalizeEventsGroup(this.globalEvents),this._attachEvents(this.channelName,this.localEvents),this._attachEvents("global",this.globalEvents)},_normalizeEventsGroup:function(a){_.each(a,function(b,c){a[c]=this.normalizeMethods(b)},this)},_attachEvents:function(a,b){b=b||{},Backbone.radio.channel(a).connectEvents(b.vent,this).connectCommands(b.commands,this).connectRequests(b.reqres,this)},emit:function(a){var b=Array.prototype.slice.apply(arguments);b[0]=this._suffixEventName(a),this.channels.global.vent.trigger.apply(this.app.vent,b)},_suffixEventName:function(a){return a+":"+this.channelName},normalizeMethods:Marionette.normalizeMethods},Backbone.Events)}();